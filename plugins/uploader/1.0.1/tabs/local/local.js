define(function(t,e,o){"use strict";function i(t){var e=this,o={type:"local",title:"本地上传",fileTypeExts:"*.png;*.jpg;*.gif;*.bmp",fileTypeDesc:"图片文件，支持:.png,.jpg,.gif,.bmp",fileSizeLimit:"5120KB",formData:{},swf:"http://s1.zhongzhihui.com/lib/plugins/uploader/1.0.1/uploadify.swf",uploader:"/api/upload.php",buttonText:"本地上传",buttonClass:"",height:54,width:"auto",debug:!1,itemTemplate:null,showPreview:!1,overrideEvents:["onSelect"],onSelect:function(t){e.uploading(!0);var o=new p(t);e.add(o)},onUploadProgress:function(t,o,i){e.updateCount();var n=e.getItem(t);n&&n.progress(o,i)},onUploadSuccess:function(t,o,i){var n=e.getItem(t);n&&(e.emit("add",o.data.url),e.remove(n))},onQueueComplete:function(){e.uploading(!1)},onFallback:function(){l.error("sorry,flash不兼容！")}};e._options=t=n.extend({},o,t),e._items=[],a.apply(e,[e._options])}var n=t("jquery"),l=(t("lib/core/1.0.0/event/emitter"),t("lib/ui/box/1.0.1/box")),r=t("lib/core/1.0.0/utils/util"),s=(t("lib/core/1.0.0/dom/build"),t("lib/plugins/uploadify/3.2.2/uploadify")),a=t("../widget"),p=t("./item");r.inherits(i,a),i.prototype._init=function(){var t=this;t.uploader=s.uploadify(t._nodes["btn-upload"][0],t._options),t._initEvent(),t._onEvent()},i.prototype._initEvent=function(){var t=this;t.uploader.on("initError",function(t){l.error("sorry,flash不兼容或没安装！")}),t.uploader.on("uploadError",function(t){var e=t&&t[1]&&t[1].errorMsg||null;e&&l.error(e)}),t.uploader.on("dialogClose",function(e){var o=e&&e.errorMsg||null;/exceeds the size limit/.test(o)&&(o="单个上传图片不能超过"+t._options.fileSizeLimit),"Some files were not added to the queue:"!=o&&o&&l.error(o)})},i.prototype.add=function(t){var e=this;e._items;e._isExistItem(t)||(e._nodes["img-list"].append(t.el),e._items.push(t),e._nodes["img-list"].stop().animate({scrollTop:e._items.length/4*87},1e3),t.on("del",function(){e.remove(t)}))},i.prototype._isExistItem=function(t){for(var e=this,o=e._items,i=0,n=o.length;i<n;i++)if(o[i]===t)return!0;return!1},i.prototype.getItem=function(t){for(var e=this,o=0;o<e._items.length;o++)if(t.id===e._items[o].file.id)return e._items[o];return null},i.prototype.remove=function(t){for(var e=this,o=0;o<e._items.length;o++)if(t===this._items[o]){e.uploader.cancel(t._options.id),t.destroy(),this._items.splice(o,1);break}return this},i.prototype.uploading=function(t){var e=this;t?e.container.addClass("local-container-uploading"):e.container.removeClass("local-container-uploading")},i.prototype._onEvent=function(){var t=this;t._nodes.cancel.on("click",function(){for(var e=0;e<t._items.length;e++)t.remove(t._items[e]);t.uploading(!1)})},i.prototype._offEvent=function(){var t=this;t._nodes.cancel.off("click")},i.prototype.updateCount=function(){var t=this;t._nodes.count.html(t._items.length)},i.prototype._makeContainer=function(){var t=this,e="";return e+='<div class="local-container">',e+='    <div class="local-init" node-type="local-init">',e+='        <div class="local-tips" node-type="local-tips">按住Ctrl可多选图片</div>',e+='        <div class="btn btn-primary btn-lg '+t._options.buttonClass+'"><button node-type="btn-upload"><span class="glyphicon glyphicon-upload"></span>选择上传</button></div>',e+="    </div>",e+='    <div class="local-uploading" node-type="local-uploading">',e+='        <div class="local-op clearfix">',e+='            <a class="btn btn-primary btn-xs" node-type="cancel" href="javascript:;"><span class="glyphicon glyphicon-remove"></span>取消上传</a><div><b node-type="count">0</b>张图片等待上传</div>',e+="        </div>",e+='        <ul class="img-list clearfix" node-type="img-list">',e+="        </ul>",e+="    </div>",e+="</div>"},o.exports=i});