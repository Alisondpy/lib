define(function(t,o,i){"use strict";function e(t){var o=this,i={type:"local",title:"本地上传",fileTypeExts:"*.png;*.jpg;*.gif;*.bmp",fileTypeDesc:"图片文件，支持:.png,.jpg,.gif,.bmp",fileSizeLimit:"5120KB",formData:{},swf:"http://s1.zhongzhihui.com/lib/plugins/uploader/1.0.1/uploadify.swf",uploader:"/api/upload.php",buttonText:"本地上传",buttonClass:"",height:54,width:"auto",debug:!1,itemTemplate:null,showPreview:!1,overrideEvents:["onSelect"],onSelect:function(t){o.uploading(!0);var i=new p(t);o.add(i)},onUploadProgress:function(t,i,e){o.updateCount();var n=o.getItem(t);n&&n.progress(i,e)},onUploadSuccess:function(t,i,e){var n=o.getItem(t);n&&(o.emit("add",i.data.url),o.remove(n))},onQueueComplete:function(){o.uploading(!1)},onFallback:function(){l.error("sorry,flash不兼容！")}};o._options=t=n.extend({},i,t),o._items=[],a.apply(o,[o._options])}var n=t("jquery"),l=(t("lib/core/1.0.0/event/emitter"),t("lib/ui/box/1.0.1/box")),r=t("lib/core/1.0.0/utils/util"),s=(t("lib/core/1.0.0/dom/build"),t("lib/plugins/uploadify/3.2.2/uploadify")),a=t("../widget"),p=t("./item");r.inherits(e,a),e.prototype._init=function(){var t=this;t.uploader=s.uploadify(t._nodes["btn-upload"][0],t._options),t._initEvent(),t._onEvent()},e.prototype._initEvent=function(){var t=this;t.uploader.on("initError",function(t){l.error("sorry,flash不兼容或没安装！")}),t.uploader.on("uploadError",function(t){var o=t&&t[1]&&t[1].errorMsg||null;o&&l.error(o)}),t.uploader.on("dialogClose",function(o){var i=o&&o.errorMsg||null;/exceeds the size limit/.test(i)&&(i="单个上传图片不能超过"+t._options.fileSizeLimit),i&&l.error(i)})},e.prototype.add=function(t){var o=this;o._items;o._isExistItem(t)||(o._nodes["img-list"].append(t.el),o._items.push(t),o._nodes["img-list"].stop().animate({scrollTop:o._items.length/4*87},1e3),t.on("del",function(){o.remove(t)}))},e.prototype._isExistItem=function(t){for(var o=this,i=o._items,e=0,n=i.length;e<n;e++)if(i[e]===t)return!0;return!1},e.prototype.getItem=function(t){for(var o=this,i=0;i<o._items.length;i++)if(t.id===o._items[i].file.id)return o._items[i];return null},e.prototype.remove=function(t){for(var o=this,i=0;i<o._items.length;i++)if(t===this._items[i]){o.uploader.cancel(t._options.id),t.destroy(),this._items.splice(i,1);break}return this},e.prototype.uploading=function(t){var o=this;t?o.container.addClass("local-container-uploading"):o.container.removeClass("local-container-uploading")},e.prototype._onEvent=function(){var t=this;t._nodes.cancel.on("click",function(){for(var o=0;o<t._items.length;o++)t.remove(t._items[o]);t.uploading(!1)})},e.prototype._offEvent=function(){var t=this;t._nodes.cancel.off("click")},e.prototype.updateCount=function(){var t=this;t._nodes.count.html(t._items.length)},e.prototype._makeContainer=function(){var t=this,o="";return o+='<div class="local-container">',o+='    <div class="local-init" node-type="local-init">',o+='        <div class="local-tips" node-type="local-tips">按住Ctrl可多选图片</div>',o+='        <div class="btn btn-primary btn-lg '+t._options.buttonClass+'"><button node-type="btn-upload"><span class="glyphicon glyphicon-upload"></span>选择上传</button></div>',o+="    </div>",o+='    <div class="local-uploading" node-type="local-uploading">',o+='        <div class="local-op clearfix">',o+='            <a class="btn btn-primary btn-xs" node-type="cancel" href="javascript:;"><span class="glyphicon glyphicon-remove"></span>取消上传</a><div><b node-type="count">0</b>张图片等待上传</div>',o+="        </div>",o+='        <ul class="img-list clearfix" node-type="img-list">',o+="        </ul>",o+="    </div>",o+="</div>"},i.exports=e});