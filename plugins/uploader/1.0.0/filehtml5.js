define(function(e,t,r){"use strict";var s=e("../../../lodash/3.1.0/lodash"),a=e("./events"),i=e("./attribute"),n=e("./utils"),o=function(e){return window&&window.File&&e instanceof File},d=function(){return window&&window.FormData&&window.XMLHttpRequest},l=0,u=function(e){var t=this,r=null;if(e.file||(e={file:e}),r=o(e.file)?e.file:null,!r)throw Error("Invalid html5 file");d()?(r.id||(r.id="__fileh5_"+ ++l),s.each(["id","name","size","type"],function(e){t.set(e,r[e])}),t.set("file",r),t.set("scale",e.scale),t.on("uploadcomplete uploaderror",function(e){t.emit("ensure",e)})):console.warn("HTML5 upload not support.")};return s.extend(u.prototype,a.prototype,i,{_uploadEventHandler:function(e){var t=this.get("xhr");switch(e.type){case"progress":this.emit("uploadprogress",{originEvent:e,bytesLoaded:e.loaded,file:this,bytesTotal:this.get("size"),percentLoaded:Math.min(100,Math.round(1e4*e.loaded/this.get("size"))/100)}),this.set("bytesUploaded",e.loaded);break;case"load":if(t.status>=200&&t.status<=299){var r=e.target.responseText;try{r=r.replace(/\/\*[\s\S]*?\*\//g,""),r=JSON.parse(r)}catch(e){}this.emit("uploadcomplete",{originEvent:e,file:this,data:r});var s=t.upload,a=this.get("boundEventHandler");s.removeEventListener("progress",a),s.removeEventListener("error",a),s.removeEventListener("abort",a),t.removeEventListener("load",a),t.removeEventListener("error",a),t.removeEventListener("readystatechange",a),this.set("xhr",null)}else this.emit("uploaderror",{originEvent:e,status:t.status,file:this,statusText:t.statusText,source:"http"});break;case"error":this.emit("uploaderror",{originEvent:e,file:this,status:t.status,statusText:t.statusText,source:"io"});break;case"abort":this.emit("uploadcancel",{originEvent:e,file:this});break;case"readystatechange":this.emit("readystatechange",{readyState:e.target.readyState,file:this,originEvent:e})}},startUpload:function(e,t,r){var a=this;a.set("bytesUploaded",0),a.set("xhr",new XMLHttpRequest),a.set("boundEventHandler",s.bind(a._uploadEventHandler,a));var i=new FormData,o=r||"Filedata",d=a.get("xhr"),l=d.upload,u=a.get("boundEventHandler"),h=a.get("file"),c=a.get("scale");d.addEventListener("loadstart",u,!1),l.addEventListener("progress",u,!1),d.addEventListener("load",u,!1),d.addEventListener("error",u,!1),l.addEventListener("error",u,!1),l.addEventListener("abort",u,!1),d.addEventListener("abort",u,!1),d.addEventListener("loadend",u,!1),d.addEventListener("readystatechange",u,!1),d.open("POST",e,!0),d.withCredentials=a.get("xhrWithCredentials"),s.each(a.get("xhrHeaders"),function(e,t){d.setRequestHeader(t,e)}),s.each(t,function(e,t){i.append(t,e)});var p=function(){i.append(o,a.get("file"),a.get("name")),a.emit("uploadstart",{xhr:d,file:a}),d.send(i)};c&&/image/i.test(h.type)?n.scaleImageFile(h,c,function(e){a.set("file",e),a.set("size",e.size),p()}):p()},isUploaded:function(){return this.get("bytesUploaded")===this.get("size")},cancelUpload:function(){this.get("xhr").abort()},destroy:function(){var e=this.get("xhr");e&&this.cancelUpload(),this.set("xhr",null),this.removeAttrs(),this.removeAllListeners()}}),u});