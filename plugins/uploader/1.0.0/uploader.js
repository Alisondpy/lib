define(function(e,t,i){"use strict";var l=e("../../../lodash/3.1.0/lodash"),a=e("./events"),n=e("./attribute"),o=e("./filehtml5"),s=e("./uploadbutton"),u=e("./utils"),r=function(e){setTimeout(e,1)},p=function(e,t){var i=this;t=l.extend({uploadOnSelect:!1,fileFilter:null,fileFieldName:"Filedata",postVarsPerFile:{},scale:null,sync:!1,className:"ui-button-upload"},t),l.each(t,function(e,t){i.set(t,e)}),i._fileList=[],i._uploader=null,i._initUploader(e)};return l.extend(p.prototype,a.prototype,n,{_initUploader:function(e){var t=this,i=l.extend({accept:t.get("accept"),multiple:t.get("multiple"),className:t.get("className"),onChange:function(e){var i=e.target.files;i?t._updateFileList(i):console.warn("No support for the File API in this web browser")}});t._uploadQueue=[],t._uploader=new s(e,i)},upload:function(e,t,i){var l=t||this.get("endpoint")||this.get("uploadURL"),a=i||this.get("postVarsPerFile"),n=e.get("id");if(a=a.hasOwnProperty(n)?a[n]:a,!l)throw Error("Upload exception, the uploader endpointer not valid");e instanceof o&&(e.on("uploadstart",this._uploadEventHandler,this),e.on("uploadprogress",this._uploadEventHandler,this),e.on("uploadcomplete",this._uploadEventHandler,this),e.on("uploaderror",this._uploadEventHandler,this),e.on("uploadcancel",this._uploadEventHandler,this),e.startUpload(l,a,this.get("fileFieldName")))},_uploadEventHandler:function(e){switch(e.type){case"uploadstart":this.emit("uploadstart",e);break;case"uploadprogress":this.emit("uploadprogress",e);break;case"uploadcomplete":this.emit("uploadcomplete",e);break;case"uploaderror":this.emit("uploaderror",e);break;case"uploadcancel":this.emit("uploadcancel",e)}},_updateFileList:function(e){var t=this,i=e,a=[],n=t.get("fileFilter"),s=t.get("scale");if(n?l.each(i,function(e){var t=new o({file:e,scale:s});n(t)?a.push(t):t.destroy()}):l.each(i,function(e){a.push(new o({file:e,scale:s}))}),a.length>0){var u=this.getFileList();this.enqueue(a),this._fileList=u.concat(a),this.emit("fileselect",{fileList:a}),this.get("uploadOnSelect")&&this.uploadThese(a)}},getFileList:function(){return this._fileList.concat()},enqueue:function(e){var t=this._uploadQueue,i=e;return i instanceof Array||(i=[e]),i.forEach(function(e,i){e&&t.indexOf(e)===-1&&t.push(e)}),this},startUpload:function(){var e=this;if(!e.get("uploading")){e.set("uploading",!0);var t=0,i=e._uploadQueue,l=e.get("sync")?1:4,a=function(){for(;t<l;){if(!i.length)return;var n=i.shift();t++,n.once("ensure",function(){t--,i.length?r(a):(e.set("uploading",!1),e.emit("queueComplete"),a=null)}),e.upload(n)}};a()}},uploadThese:function(e){this.enqueue(e),this.startUpload()},removeFile:function(e){this._fileList=l.filter(this._fileList,function(t){return t.get("id")!==e||(t.destroy(),self.emit("fileremove",{file:file}),!1)})},destroy:function(){this._fileList=[],this.removeAllListeners(),this._uploader.destroy(),this._uploader=null}}),p.genImageFileThumbnail=u.genImageFileThumbnail,p});