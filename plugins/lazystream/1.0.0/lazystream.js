define(function(e,t,r){"use strict";var a=e("jquery"),i=e("../../../core/1.0.0/utils/util"),n=e("../../../core/1.0.0/io/request"),o=e("../../lazyload/1.9.3/lazyload"),l=i.setImmediate;o.define("stream",function(e,t,r,i){var o=this,l=a(e),s=r.plUrl,d=+e.getAttribute("data-page")||0,u=r.paramFormater(d),c=r.dataFilter||function(e){return e.data};n.jsonp(s,u,function(e){if(!+e.error){var t=c(e);if(t)try{t=unescape(t)}catch(e){}else t=r.endText||"";l.html(t),o.emit("data",{page:d,data:e.data})}}).always(function(e){var t=e.data;if(t&&0===+(t.error||0))i(null,t);else{i(t);var a='<div class="stream-error">'+(r.errorText||e.msg)+"</div>";l.html(a).off("click").on("click",function(e){e.preventDefault(),o.update()}),o.emit("error",e)}})});var s=function(e,t){var r=this;if(t=t||{},e=a(e),!t.plUrl)throw"Init lazystream failed, The pagelet api `plUrl` not defined";t=a.extend(!0,{plUrl:"",page:1,paramFormater:function(e){return{page:e}},errorText:"",noAnyMore:""},t),t.type="stream",t.page=+t.page||1,o.apply(r,[null,t]);var i=t.loadingClass;i&&e.find("."+i).remove(),r._view=e,r._cursor=null,r.on("lazyItemReady",function(e,t,a){l(function(){r.loadNext()})}),r.loadNext()};i.inherits(s,o,{_addHolder:function(e){var t=this._cursor,r=this._,i=a('<div class="'+r.loadingClass+'" data-page="'+e+'">'+r.loadingText+"</div>")[0];return t?a(t).after(i):this._view.append(i),this.add(i),this._cursor=i},hasNext:function(){var e=this._cursor;return e&&e.firstChild},loadNext:function(){var e=this._cursor,t=this._;if(!e||this.hasNext())this._addHolder(t.page++);else{var r=t.noAnyMore;r&&a(e).html(r)}return this.update(),this}}),r.exports=s});