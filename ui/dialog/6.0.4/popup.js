define(function(t){"use strict";function e(){this._popup=i("<div />").css({display:"none",position:"absolute",outline:0}).attr("tabindex","-1").html(this.innerHTML).appendTo("body"),this._backdrop=this._mask=i("<div />").css({opacity:.7,background:"#000"}),this.node=this._popup[0],this.backdrop=this._backdrop[0],this.destroyed=!1}var i=t("jquery"),s=t("../../../core/1.0.0/utils/util"),o=t("../../../core/1.0.0/event/emitter"),h=window.document,r=!("minWidth"in h.documentElement.style),n=!r;return s.inherits(e,o),i.extend(e.prototype,{node:null,backdrop:null,fixed:!1,destroyed:!0,open:!1,returnValue:"",autofocus:!0,align:"bottom left",innerHTML:"",className:"ui-popup",show:function(t){if(this.destroyed)return this;this.emit("beforeShow");var s=this._popup,o=this._backdrop;if(this._activeElement=this._getActive(),this.open=!0,this.follow=t||this.follow,!this._ready){if(s.addClass(this.className).attr("role",this.modal?"alertdialog":"dialog").css("position",this.fixed?"fixed":"absolute"),this.zIndex&&s.css("zIndex",this.zIndex),r||i(window).on("resize",i.proxy(this.reset,this)),this.modal){var a={position:"fixed",left:0,top:0,width:"100%",height:"100%",overflow:"hidden",userSelect:"none",zIndex:this.zIndex||e.zIndex};s.addClass(this.className+"-modal"),n||i.extend(a,{position:"absolute",width:i(window).width()+"px",height:i(h).height()+"px"}),o.css(a).attr({tabindex:"0"}).on("focus",i.proxy(this.focus,this)),this._mask=o.clone(!0).attr("style","").insertAfter(s),o.addClass(this.className+"-backdrop").insertBefore(s),this._ready=!0}s.html()||s.html(this.innerHTML)}return s.addClass(this.className+"-show").show(),o.show(),this.reset().focus(),this.emit("show"),this},showModal:function(){return this.modal=!0,this.show.apply(this,arguments)},close:function(t){return!this.destroyed&&this.open&&(void 0!==t&&(this.returnValue=t),this._popup.hide().removeClass(this.className+"-show"),this._backdrop.hide(),this.open=!1,this.blur(),this.emit("close")),this},remove:function(){if(this.destroyed)return this;this.emit("beforeremove"),e.current===this&&(e.current=null),this._popup.remove(),this._backdrop.remove(),this._mask.remove(),r||i(window).off("resize",this.reset),this.emit("remove");for(var t in this)delete this[t];return this},reset:function(){var t=this.follow;return t?this._follow(t):this._center(),this.emit("reset"),this},focus:function(t){var s=this.node,o=this._popup,h=e.current,r=this.zIndex;if(h&&h!==this&&h.blur(!1),!i.contains(s,this._getActive())){var n=o.find("[autofocus]")[0];!this._autofocus&&n?this._autofocus=!0:n=s,this._focus(n)}return void 0===r&&(r=this.zIndex=e.zIndex++,o.css("zIndex",r),o.addClass(this.className+"-focus")),e.current=this,this.emit("focus"),this},blur:function(){var t=this._activeElement,e=arguments[0];return e!==!1&&this._focus(t),this._autofocus=!1,this._popup.removeClass(this.className+"-focus"),this.emit("blur"),this},emit:function(t){var e=Array.prototype.slice.call(arguments,1),i=this["on"+t];"function"==typeof i&&i.apply(this,e),o.prototype.emit.apply(this,arguments)},_focus:function(t){try{this.autofocus&&!/^iframe$/i.test(t.nodeName)&&t.focus()}catch(t){}},_getActive:function(){try{var t=h.activeElement,e=t.contentDocument,i=e&&e.activeElement||t;return i}catch(t){}},_center:function(){var t=this._popup,e=i(window),s=i(h),o=this.fixed,r=o?0:s.scrollLeft(),n=o?0:s.scrollTop(),a=e.width(),l=e.height(),f=t.width(),c=t.height(),d=(a-f)/2+r,p=382*(l-c)/1e3+n,u=t[0].style;u.left=Math.max(parseInt(d),r)+"px",u.top=Math.max(parseInt(p),n)+"px"},_follow:function(t){var e=t.parentNode&&i(t),s=this._popup;if(this._followSkin&&s.removeClass(this._followSkin),e){var o=e.offset();if(o.left*o.top<0)return this._center()}var r=this,n=this.fixed,a=i(window),l=i(h),f=a.width(),c=a.height(),d=l.scrollLeft(),p=l.scrollTop(),u=s.width(),m=s.height(),w=e?e.outerWidth():0,_=e?e.outerHeight():0,v=this._offset(t),x=v.left,b=v.top,y=n?x-d:x,g=n?b-p:b,k=n?0:d,I=n?0:p,z=k+f-u,N=I+c-m,C={},T=this.align.split(" "),E=this.className+"-",L={top:"bottom",bottom:"top",left:"right",right:"left"},M={top:"top",bottom:"top",left:"left",right:"left"},A=[{top:g-m,bottom:g+_,left:y-u,right:y+w},{top:g,bottom:g-m+_,left:y,right:y-u+w}],S={left:y+w/2-u/2,top:g+_/2-m/2},H={left:[k,z],top:[I,N]};i.each(T,function(t,e){A[t][e]>H[M[e]][1]&&(e=T[t]=L[e]),A[t][e]<H[M[e]][0]&&(T[t]=L[e])}),T[1]||(M[T[1]]="left"===M[T[0]]?"top":"left",A[1][T[1]]=S[M[T[1]]]),E+=T.join("-")+" "+this.className+"-follow",r._followSkin=E,e&&s.addClass(E),C[M[T[0]]]=parseInt(A[0][T[0]]),C[M[T[1]]]=parseInt(A[1][T[1]]),s.css(C)},_offset:function(t){var e=t.parentNode,s=e?i(t).offset():{left:t.pageX,top:t.pageY};t=e?t:t.target;var o=t.ownerDocument,h=o.defaultView||o.parentWindow;if(h==window)return s;var r=h.frameElement,n=i(o),a=n.scrollLeft(),l=n.scrollTop(),f=i(r).offset(),c=f.left,d=f.top;return{left:s.left+c-a,top:s.top+d-l}}}),e.zIndex=1024,e.current=null,e});