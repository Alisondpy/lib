define(function(e,t,n){"use strict";function o(e){var t=this,n={autofocus:!0,fixed:!1,align:"bl",className:"",clickBlankToHide:!1,appendTo:"body",autoRelease:!1,html:"",modal:!1,showWithAni:"bounceIn:fast",hideWithAni:"bounceOut:fast"};t._=e=w(n,e),e.fixed=!!e.fixed&&I();var r=i('<div class="'+m+'" id="'+(e.id||y())+'" />').css({display:"none",position:"absolute",outline:0}).attr("tabindex","-1").html(e.html),s=i("<div />");if(t._popup=r,t._mask=t._shadow=s,t.node=r[0],t.mask=s[0],t.on("render",function(e){var n,i=e.className,s=t._mask,a=e.zIndex;r.html()||r.html(e.html),i&&r.addClass(i),r.css("position",e.fixed?"fixed":"absolute"),a&&r.css("zIndex",a),e.modal&&(r.addClass(m+"-modal"),n={position:"fixed",left:0,top:0,width:"100%",height:"100%",overflow:"hidden",userSelect:"none",zIndex:a||o.zIndex,backgroundColor:"#000",opacity:.3},I()||w(n,{position:"absolute",width:f.width()+"px",height:u.height()+"px"}),s.attr("tabIndex",0).on("focus",x(t.focus,t)),t._shadow=s.clone(!0),s.css(n).addClass(m+"-mask"))}),t.on("beforeShow",function(e){var n=t.anchor,o=t._dirClass;!n&&o&&(r.removeClass(o),delete t._dirClass)}),t.on("show",function(e){t.resize(),e.modal&&(t._mask.insertBefore(r).css("display","block"),t._shadow.insertAfter(r)),e.autofocus&&t.focus()}),t.on("hide",function(e){t._mask.remove(),t._shadow.remove(),t.blur()}),t.once("destroy",function(){r.off(),r=null,t._mask.off(),t._shadow.off()}),!p){var a=x(t.resize,t);t.on("render",function(){f.on("resize",a)}),t.on("destroy",function(){f.off("resize",a)})}t.destroyed=!1,t.initialized=!0}var i=e("jquery"),r=e("../../../core/1.0.0/utils/util"),s=e("../../../core/1.0.0/utils/css"),a=e("../../../core/1.0.0/event/emitter"),l=window,d=l.document,f=i(l),u=i(d),c=d.documentElement,h=/\S+/g,p=!("minWidth"in c.style),m="ui-layer",v=l.Math,_=v.max,g=v.ceil,y=r.guid,w=r.extend,b=r.each,x=function(e,t){return e.bind?e.bind(t):function(){return e.apply(t,arguments)}},C=r.setImmediate,z=function(e){return l.parseInt(e,10)||0},k=function(e){return e&&1===e.nodeType},I=function(){return I._||(I._=function(){var e=d.createElement("div"),t=e.cloneNode(!1),n=!1,o=d.body||function(){return n=!0,c.appendChild(d.createElement("body"))}();e.style.cssText="position:fixed;top:42px",o.appendChild(e),o.appendChild(t);var i=e.offsetTop!==t.offsetTop;return o.removeChild(e),o.removeChild(t),n&&c.removeChild(o),e=t=null,i}())},T=function(){return{x:u.scrollLeft(),y:u.scrollTop()}},A=function(e){return{w:e.width(),h:e.height()}},E=function(){return A(f)},N=function(e){var t=k(e),n=t?i(e).offset():{left:e.pageX,top:e.pageY};e=t?e:e.target;var o=e.ownerDocument;if(o===l.document)return n;var r=o.defaultView||o.parentWindow,s=r.frameElement,a=T(),d=i(s).offset();return{left:n.left+d.left-a.x,top:n.top+d.top-a.y}},W=function(e,t){if(e.length){var n=z(e.css(t))||e[0]["offset"+t.charAt(0).toUpperCase()+t.slice(1)],o={width:["left","right"],height:["top","bottom"]};return b(o[t],function(t,o){n+=z(e.css("margin-"+t),10)||0}),n}return 0},$=function(e){return W(e,"width")},S=function(e){return W(e,"height")},B=function(){try{var e=d.activeElement,t=e.contentDocument;return t&&t.activeElement||e}catch(e){}},j=function(e){e=e||"";var t={auto:!0},n=e.slice(-1);"!"===n&&(t.auto=!1,e=e.slice(0,-1));for(var o,e=e.length<=2?e.split(""):e.replace(/^\s+|\s+$/g,"").split(" ").slice(0,2),i={},r={t:"t",b:"t",l:"l",r:"l"},s=-1,a=e.length;++s<a;)o=e[s].charAt(0),!o||i[r[o]]?e.splice(s,1):(e[s]=o,i[r[o]]=1);return 2===e.length&&e[0]===e[1]&&e.pop(),t.align=e,t};r.inherits(o,a,{open:!1,destroyed:!0,node:null,mask:null,emit:function(e){for(var t=(e||"").match(h)||[],n=t.length;n--;){var i=this["on"+t[n]],r=Array.prototype.slice.call(arguments,1);"function"==typeof i&&i.apply(this,r)}o.__super__.emit.apply(this,arguments)},$:function(e,t){var n=this._nodes||(this._nodes={}),o=n[e];return(!o||t&&0===o.length)&&(o=this._popup.find('[node-type="'+e+'"]'),t&&o.length>0&&(n[e]=o)),!t||o.length?o:null},show:function(e,t){var n,o=this,i=o._,r=e,a=null,l=o._anim;if(l&&l.stop(!0),o.destroyed||i.showing||o.open)return o;t=w({},o._,t),void 0!==r&&(n=typeof r,"boolean"===n?t.modal=r:r&&"object"===n&&(k(r)||k(r.target)?a=r:w(t,r)));var d=o._popup,f=t.showWithAni,u=function(){delete i.showing,o.emit("shown")};if(o._ready||(o.emit("render",t),o._ready=!0),o.open=!0,o.anchor=a,o._activeElement=B(),o.emit("beforeShow",t),d.appendTo(t.appendTo).css("display","block"),o.emit("show",t),i.showing=!0,f&&"none"!==f){var c=f.split(":");o._anim=s.effect(o.node,c[0],c[1],u)}else u();return o},hide:function(e){var t,n=this,o=n._,i=n.node,r=o.hideWithAni,a=n._anim;if(a&&a.stop(!0),n.destroyed||o.hidding||!n.open)return n;if(n.emit("beforeHide"),o.hidding=!0,t=function(){o.hidding===!0&&(i.parentNode.removeChild(i),n._popup.hide(),delete o.hidding,n.open=!1,n.emit("hidden"),(e||o.autoRelease)&&n.destroy())},r&&"none"!==r){var l=r.split(":");n._anim=s.effect(i,l[0],l[1],t),n.emit("hide")}else n.emit("hide"),C(t);return n},destroy:function(){var e=this;return e.destroyed?e:(e.emit("beforeremove"),o.current===e&&(o.current=null),e._popup.off().remove(),e._mask.off().remove(),e._shadow.off().remove(),e.emit("destroy"),e.removeAllListeners(),b(e,function(t,n){delete e[n]}),e._={},e.destroyed=!0,e)},resize:function(){var e=this._;if(this.open&&this._ready&&!e.showing&&!this._freezing){var t=this.anchor;t?this.alignTo(t):this.center(),this.emit("resize")}return this},_freeze:function(e){return this._freezing=!!e,this},focus:function(e){var t=this._,n=this.node,r=this._popup,s=o.current,a=t.zIndex;if(s&&s!==this&&s.blur(!1),!i.contains(n,B())){var l=r.find("[autofocus]")[0];!t.focusing&&l?t.focusing=!0:l=n,this._focus(l)}return void 0===a&&(a=t.zIndex=o.zIndex++,r.css("zIndex",a),r.addClass(m+"-focus")),o.current=this,this.emit("focus"),this},blur:function(){var e=this._,t=arguments[0],n=this._activeElement;return n?(t!==!1&&this._focus(n),delete e.focusing,delete this._activeElement,this._popup.removeClass(m+"-focus"),this.emit("blur"),this):this},_focus:function(e){if(e&&this._.autofocus&&!/^iframe$/i.test(e.nodeName))try{e.focus()}catch(e){}},center:function(){var e=this._popup,t=this._.fixed,n=T(),o=E(),i=A(e),r=t?0:n.x,s=t?0:n.y,a=(o.w-i.w)/2+r,l=.382*(o.h-i.h)+s;return e.css({left:_(z(a),r),top:_(z(l),s)}),this},alignTo:function(e,t){var n=this,o=n._,r=n._popup,s=e.parentNode&&i(e);if(!s)return n;var a=s.offset();if(a.left*a.top<0)return n.center();t=t||o.align;var l=j(t),d=l.align,f=!l.auto;d&&d.length||(console.warn("Popup align not valid. align to top instead."),d=["b"]);var u=n._dirClass;u&&r.removeClass(u);var c=o.fixed,h=E(),p=T(),v=$(r),_=S(r),y=N(e),w=$(s),x=S(s),C=y.left,k=y.top,I=c?C-p.x:C,A=c?k-p.y:k,W=c?0:p.x,B=c?0:p.y,D=W+h.w-v,H=B+h.h-_,L={t:"b",b:"t",l:"r",r:"l"},O={t:"top",b:"top",l:"left",r:"left"},R={},q=[{t:A-_,b:A+x,l:I-v,r:I+w},{t:A,b:A-_+x,l:I,r:I-v+w}],M={l:I+g((w-v)/2),t:A+g((x-_)/2)},P={left:[W,D],top:[B,H]};f||b(d,function(e,t){q[t][e]>P[O[e]][1]&&(e=d[t]=L[e]),q[t][e]<P[O[e]][0]&&(d[t]=L[e])});var U=d[0];d[1]||(d[1]="left"===O[U]?"t":"l",q[1][d[1]]=M[d[1]]),q[0][U]=q[0][U]+10*("tl".indexOf(U)!==-1?-1:1),R[O[d[0]]]=z(q[0][d[0]]),R[O[d[1]]]=z(q[1][d[1]]);var V=m+"-"+U;r.css(R).addClass(V),n._dirClass=V;var X=n.$("arrow",1),Y=n.$("inner",1);if(!X){if(!Y)return console.warn("Init popup hooks align failed, Both `arrow` and `inner` section cannot found."),n;X=i('<div node-type="arrow" class="ui-arrow"><i></i><b></b></div>').appendTo(Y)}var F,G,J="top"!==O[U],K=["v","h"][1^J],Q=$(X),Z=S(X),ee={},te=J?"left":"top";switch(K){case"h":F=g(C+(w-Q)/2),ee.left=F;break;case"v":G=g(k+(x-Z)/2),ee.top=G}return X.offset(ee).css(te,""),n}}),o.zIndex=1024,o.current=null,n.exports=o});