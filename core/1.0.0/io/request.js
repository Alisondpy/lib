define(function(t,e,n){"use strict";var r=t("jquery"),o=t("../utils/util"),s=t("../event/emitter"),a=o.setImmediate,i=o.noop,u=o.extend,c=r.trim,p=r.parseJSON,f=function(t,e,n){return function(r,o){try{return t.apply(e,arguments)}catch(t){n&&n(t,r,o)}}},l=function(t){return e.emit.apply(e,arguments)};s.applyTo(e);var d=function(){var t=5,e=0,n=[],o=function(){a(function(){--e,s()})},s=function(){if(n.length>0&&e<t){var s=n.shift(),a=s[0],i=s[1];++e,a.always(o),r.ajax(i)}};return function(t,e){n.push([t,e]),s()}}(),y=function(t){s.applyTo(this);var e={url:"",type:"GET",data:{},dataType:"json",timeout:3e4,cache:!1};t=u(e,t),delete t.error,delete t.success,this._opts=t};u(y.prototype,{send:function(){var t=this,e=this._opts,n=u({},e),r="jsonp"===n.dataType;return r&&(n.crossDomain=!0),n.complete=function(n,o){var s,a=+n.status,i=n.responseJSON,u={error:"1",msg:"Request error (status: "+(o||a)+")"},f=200===a||"success"===o;if(!r&&!i&&(i=c(n.responseText),i&&"<"!==i.charAt(0)))try{i=p(i)}catch(t){}f||(i=i||u),s={data:i,xhr:n,origin:e,status:a||o},f?t.emit("response",null,s):t.emit("error",i,s),t.emit("end",s),t.destroy()},d(t,n),t},always:function(t){return"function"==typeof t&&this.on("end",t),this},destroy:function(){this.un(),this._opts=null}}),e.on("request",function(t,e){if(e=e&&r(e)){var n="disabled";e.addClass(n).prop("disabled",!0),t.once("end",function(){e.removeClass(n).prop("disabled",!1),e=null})}}),e.ajax=function(t,e,n){"object"==typeof t&&(n=e,e=t,t=void 0),e=e||{},t&&(e.url=t);var o=new y(e),s=function(t,n){var r=t.stack&&t.stack.split("\n").slice(0,2).join("\n")||t,o={stack:r,origin:e,response:n};l("error",o,n),a(function(){console.log("%c "+r,"color:#ae0000")},1)},u=f(e.error||i,null,s),c=f(e.success||i,null,s);if(l("request",o,n)!==!1){if(n&&(n=r(n))){var p,d,v="data-async-lock";if(1===+n.attr(v))return;(d=n.attr("data-async-text"))&&(p=n.html(),n.html(d)),n.attr(v,1),o.once("response error",function(){n&&(n.attr(v,0),d&&n.html(p),n=null)})}return o.on("error",function(t,e){var n={code:t.error,message:t.msg,status:e.status,origin:e.origin,response:e.data};l("error",n,e)!==!1&&u(t)}),o.on("response",function(t,e){if(e=e.data,l("response",e)!==!1)return t?void u(t):void(e&&0===+(e.error||0)?c(e):u(e))}),o.send()}},r.each(["get","post","jsonp"],function(t,n){e[n]=function(t,r,o,s,a){"function"==typeof r&&(a=a||s,s=o,o=r,r=void 0),s&&"function"!=typeof s&&(a=s,s=void 0);var i={data:r,success:o,error:s||o};"string"==typeof t?i.url=t:u(i,t);var c=n;return"jsonp"===n&&(c="get",i.dataType="jsonp"),i.type=c,e.ajax(i,a)}})});