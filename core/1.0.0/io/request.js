define(function(t,e,n){"use strict";var r=t("jquery"),o=t("../utils/util"),s=t("../event/emitter"),a=o.setImmediate,i=o.noop,u=o.extend,c=r.trim,l=r.parseJSON,p=function(t,e,n){return function(r,o){try{return t.apply(e,arguments)}catch(t){n&&n(t,r,o)}}},f=function(t){return e.emit.apply(e,arguments)};s.applyTo(e);var d=function(){var t=5,e=0,n=[],o=function(){a(function(){--e,s()})},s=function(){if(n.length>0&&e<t){var s=n.shift(),a=s[0],i=s[1];++e,a.always(o),r.ajax(i)}};return function(t,e){n.push([t,e]),s()}}(),y=function(t){s.applyTo(this);var e={url:"",type:"GET",data:{},dataType:"json",timeout:3e4,cache:!1};t=u(e,t),delete t.error,delete t.success,this._opts=t};u(y.prototype,{send:function(){var t=this,e=this._opts,n=u({},e),r="jsonp"===n.dataType;return r&&(n.crossDomain=!0),n.complete=function(n,o){var s,a=+n.status,i=n.responseJSON,u={error:"1",msg:"Request error (status: "+(o||a)+")"},p=200===a||"success"===o;if(!r&&!i&&(i=c(n.responseText),i&&"<"!==i.charAt(0)))try{i=l(i)}catch(t){}p||(i=i||u),s={data:i,xhr:n,origin:e,status:a||o},p?t.emit("response",null,s):t.emit("error",i,s),t.emit("end",s),t.destroy()},d(t,n),t},always:function(t){return"function"==typeof t&&this.on("end",t),this},destroy:function(){this.un(),this._opts=null}}),e.on("request",function(t,e){if(e=e&&r(e)){if(1===+e.attr("data-async-lock"))return;e.attr("data-interval",1*new Date);var n="disabled";e.addClass(n).prop("disabled",!0),t.once("end",function(){e.removeClass(n).prop("disabled",!1),e=null})}}),e.ajax=function(t,e,n,o){o=o||1e3,"object"==typeof t&&(n=e,e=t,t=void 0),e=e||{},t&&(e.url=t);var s=new y(e),u=function(t,n){var r=t.stack&&t.stack.split("\n").slice(0,2).join("\n")||t,o={stack:r,origin:e,response:n};f("error",o,n),a(function(){console.log("%c "+r,"color:#ae0000")},1)},c=p(e.error||i,null,u),l=p(e.success||i,null,u);if(f("request",s,n)!==!1){if(n&&(n=r(n))){var d,v,h="data-async-lock";if(1===+n.attr(h))return;(v=n.attr("data-async-text"))&&(d=n.html(),n.html(v)),n.attr(h,1),s.once("response error",function(){if(n){var t=n.attr("data-interval"),e=1*new Date,r=e-t;r>o?(n.attr(h,0),n=null):setTimeout(function(){n.attr(h,0),n=null},o-r),v&&n.html(d)}})}return s.on("error",function(t,e){var n={code:t.error,message:t.msg,status:e.status,origin:e.origin,response:e.data};f("error",n,e)!==!1&&c(t)}),s.on("response",function(t,e){if(e=e.data,f("response",e)!==!1)return t?void c(t):void(e&&0===+(e.error||0)?l(e):c(e))}),s.send()}},r.each(["get","post","jsonp"],function(t,n){e[n]=function(t,r,o,s,a,i){i=i||1e3,"function"==typeof r&&(a=a||s,s=o,o=r,r=void 0),s&&"function"!=typeof s&&(a=s,s=void 0);var c={data:r,success:o,error:s||o};"string"==typeof t?c.url=t:u(c,t);var l=n;return"jsonp"===n&&(l="get",c.dataType="jsonp"),c.type=l,e.ajax(c,a,i)}})});