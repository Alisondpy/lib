!function(t,e,n){"function"==typeof define&&define.amd?define(n):t[e]=n()}(this,"Messenger",function(){"use strict";function t(t,e){var n="";if(arguments.length<2?n="target and channelId are both requied":"object"!=typeof e?n="target must be window object":"string"!=typeof t&&(n="target channelId must be string type"),n)throw"TargetError: "+n;this._channelId=t,this.target=e}function e(t){arguments.length>1&&(t=arguments[1]);var t=t||"$";if(_[t])throw'DuplicateError: a channel with id "'+t+'" is already exists.';_[t]=1,this._attached=!1,this._targets=[],this.handleMessage=g(this.handleMessage,this),this._channelId=t,this._listeners={}}var n=window,r=n.document,i=n.navigator,s=Object.prototype.hasOwnProperty,a="postMessage"in n,o="addEventListener"in r,h=n.JSON||0,c="__mc__",d="<__JSON__>",f=function(t){var e;if(!t||"object"!=typeof t||t.nodeType||t.window===t)return!1;try{if(t.constructor&&!s.call(t,"constructor")&&!s.call(t.constructor.prototype,"isPrototypeOf"))return!1}catch(t){return!1}for(e in t);return void 0===e||s.call(t,e)},u=h.stringify||function t(e){var n=typeof e;if("object"!==n||null===e)return"string"===n&&(e='"'+e+'"'),String(e);var r,i,s=[],a=e&&e.constructor==Array;for(r in e)i=e[r],n=typeof i,e.hasOwnProperty(r)&&("string"===n?i='"'+i+'"':"object"===n&&null!==i&&(i=t(i)),s.push((a?"":'"'+r+'":')+String(i)));return(a?"[":"{")+String(s)+(a?"]":"}")},l=h.parse||function(t){return(0,n.eval)("("+t+")")},g=function(t,e){return t.bind?t.bind(e):function(){t.apply(e,arguments)}},p=function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t};t.prototype.send=a?function(t){this.target.postMessage(this._channelId+t,"*")}:function(t){var e=this._channelId,r=i[e];if("function"!=typeof r)throw'Target (channel="'+e+'") callback function is not defined';try{r(e+t,n)}catch(t){}};var _={};return p(e.prototype,{_mId:0,_initMessenger:function(){var t,e=this;e._attached||(e._attached=!0,t=e.handleMessage,a?o?n.addEventListener("message",t,!1):n.attachEvent("onmessage",t):i[e._channelId]=t)},addTarget:function(e){for(var n=this._targets,r=n.length;r--;)if(n[r][0]===e)return this;return n.push([e,new t(this._channelId,e)]),this},removeTarget:function(t){for(var e=this._targets,n=e.length;n--;)e[n][0]===t&&e.splice(n,1);return this},handleMessage:function(t){var e=this;if(t){var n,r,i,s,a=t,o=this._channelId;if("object"==typeof t&&(a=t.data),0===a.indexOf(o)){if(a=a.substring(o.length),0===a.indexOf(d))try{r=l(a.substring(d.length))}catch(t){setTimeout(function(){console.error(t,a)},1)}else r={type:"*",data:a};(n=r&&r.type)&&(i=t.source,s={target:t.target,source:i,send:function(t){e.addTarget(i),e.send(c+o+"_"+r.mId,t),e.removeTarget(i)}},e.emit(n,r.data,s))}}},listen:function(t,e){return void 0===e&&(e=t,t="*"),this.on(t,e),this},clear:function(){return this._listeners={},this},sendMessage:function(t,e,n){if("function"==typeof e&&(n=e,e=void 0),"object"==typeof e&&!f(e))throw"The CORSS message data not a valid plain object.";var r=++this._mId,i=this._channelId,s=this._targets,a={type:t,data:e,mId:r};"function"==typeof n&&this.on(c+i+"_"+r,function(e){n({type:t,data:e,mId:r})}),e=d+u(a);for(var o=s.length;o--;)s[o][1].send(e);return this},send:function(t,e,n){return void 0===e&&(e=t,t="*"),this.sendMessage(t,e,n)},on:function(t,e){return this._initMessenger(),this._listeners[t]||(this._listeners[t]=[]),"function"==typeof e&&this._listeners[t].push(e),this},emit:function(t){var e=this._listeners[t];if(e)for(var n=0,r=e.length,i=Array.prototype.slice.call(arguments,1);n<r;n++)e[n].apply(this,i);return this},destroy:function(){if(a){var t=this.handleMessage;o?n.removeEventListener("message",t):n.detachEvent("onmessage",t)}else delete i[this._channelId];this.clear(),this._targets.length=0,delete _[this._channelId]}}),e});