define(function(t,i,e){"use strict";var n=t("_"),s=n.isArray,r=n.isEmpty,h=n.escapeRegExp,o=function(t){return null!==t&&void 0!==t&&(!n.isNumber(t)||isFinite(t))},u=function(t,i,e,n){if(!t.exec){var s=h;t=String(t),i===!0?t=s(t):(t="^"+s(t),n===!0&&(t+="$")),t=new RegExp(t,e?"":"i")}return t},f=function(t,i){!i&&n.isObject(t)&&(i=t);var e;"function"==typeof i?(e=i,i={}):(i=i||{},e=i.keyFn),this.dic={},this.items=[],this.keys=[],this.length=0,this.allowFunctions=i.allowFunctions===!0,e?this.getKey=e:this.pkey=i.primaryKey||"id",s(t)&&t.length>0&&this.addAll(t)};return f.prototype={constructor:f,add:function(t,i){if(1==arguments.length&&(i=arguments[0],t=this.getKey(i)),o(t)){var e=this.dic[t];if("undefined"!=typeof e)return this.replace(t,i);this.dic[t]=i}return this.length++,this.items.push(i),this.keys.push(t),i},getKey:function(t){return t[this.pkey]},replace:function(t,i){1==arguments.length&&(i=arguments[0],t=this.getKey(i));var e=this.dic[t];if(!o(t)||void 0===e)return this.add(t,i);var n=this.indexOfKey(t);return this.items[n]=i,this.dic[t]=i,i},addAll:function(t){if(arguments.length>1||s(t))for(var i=arguments.length>1?arguments:t,e=0,n=i.length;e<n;e++)this.add(i[e]);else for(var r in t)(this.allowFunctions||"function"!=typeof t[r])&&this.add(r,t[r])},each:function(t,i){for(var e=[].concat(this.items),n=0,s=e.length;n<s&&t.call(i||e[n],e[n],n,s)!==!1;n++);},map:function(t,i){var e,n,s,r,h;if("function"!=typeof t)throw new TypeError(t+" is not a function");for(r=this.items,h=r.length>>>0,e=i,n=new Array(h),s=0;s<h;){var o,u;s in r&&(o=r[s],u=t.call(e||o,o,s,r),n[s]=u),s++}return n},eachKey:function(t,i){for(var e=0,n=this.keys.length;e<n;e++)t.call(i||window,this.keys[e],this.items[e],e,n)},find:function(t,i){for(var e=0,n=this.items.length;e<n;e++)if(t.call(i||window,this.items[e],this.keys[e]))return this.items[e];return null},insert:function(t,i,e){return 2==arguments.length&&(e=arguments[1],i=this.getKey(e)),t>=this.length?this.add(i,e):(this.length++,this.items.splice(t,0,e),"undefined"!=typeof i&&null!==i&&(this.dic[i]=e),this.keys.splice(t,0,i),e)},remove:function(t){return this.removeAt(this.indexOf(t))},removeAt:function(t){if(t<this.length&&t>=0){this.length--;var i=this.items[t];this.items.splice(t,1);var e=this.keys[t];return"undefined"!=typeof e&&delete this.dic[e],this.keys.splice(t,1),i}return!1},removeKey:function(t){return this.removeAt(this.indexOfKey(t))},getCount:function(){return this.length},indexOf:function(t){return this.items.indexOf(t)},indexOfKey:function(t){return this.keys.indexOf(t)},item:function(t){var i=this.dic[t],e=void 0!==i?i:"number"==typeof t?this.items[t]:void 0;return"function"!=typeof e||this.allowFunctions?e:null},itemAt:function(t){return this.items[t]},key:function(t){return this.dic[t]},contains:function(t){return this.indexOf(t)!==-1},containsKey:function(t){return"undefined"!=typeof this.dic[t]},clear:function(){return this.length=0,this.dic={},this.items=[],this.keys=[],this},first:function(){return this.items[0]},last:function(){return this.items[this.length-1]},_sort:function(t,i,e){var n,s,r="DESC"==String(i).toUpperCase()?-1:1,h=[],o=this.keys,u=this.items;for(e=e||function(t,i){return t-i},n=0,s=u.length;n<s;n++)h[h.length]={key:o[n],value:u[n],index:n};for(h.sort(function(i,n){var s=e(i[t],n[t])*r;return 0===s&&(s=i.index<n.index?-1:1),s}),n=0,s=h.length;n<s;n++)u[n]=h[n].value,o[n]=h[n].key},sort:function(t,i){this._sort("value",t,i)},reorder:function(t){var i,e=this.items,n=0,s=e.length,r=[],h=[];for(i in t)r[t[i]]=e[i];for(n=0;n<s;n++)void 0==t[n]&&h.push(e[n]);for(n=0;n<s;n++)void 0==r[n]&&(r[n]=h.shift());this.clear(),this.addAll(r)},keySort:function(t,i){this._sort("key",t,i||function(t,i){var e=String(t).toUpperCase(),n=String(i).toUpperCase();return e>n?1:e<n?-1:0})},getRange:function(t,i){var e=this.items;if(e.length<1)return[];t=t||0,i=Math.min("undefined"==typeof i?this.length-1:i,this.length-1);var n,s=[];if(t<=i)for(n=t;n<=i;n++)s[s.length]=e[n];else for(n=t;n>=i;n--)s[s.length]=e[n];return s},filter:function(t,i,e,n){return r(i,!1)?this.clone():(i=u(i,e,n),this.filterBy(function(e){return e&&i.test(e[t])}))},filterBy:function(t,i){var e=new f;e.getKey=this.getKey;for(var n=this.keys,s=this.items,r=0,h=s.length;r<h;r++)t.call(i||this,s[r],n[r])&&e.add(n[r],s[r]);return e},findIndex:function(t,i,e,n,s){return r(i,!1)?-1:(i=u(i,n,s),this.findIndexBy(function(e){return e&&i.test(e[t])},null,e))},findIndexBy:function(t,i,e){for(var n=this.keys,s=this.items,r=e||0,h=s.length;r<h;r++)if(t.call(i||this,s[r],n[r]))return r;return-1},clone:function(){for(var t=new f,i=this.keys,e=this.items,n=0,s=e.length;n<s;n++)t.add(i[n],e[n]);return t.getKey=this.getKey,t}},f});